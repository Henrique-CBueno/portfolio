version: "3.8"

services:
  redis:
    image: redis:7-alpine
    container_name: portfolio_redis
    command: >
      sh -c "redis-server --requirepass \"$REDIS_PASSWORD\""
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "$REDIS_PASSWORD", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    networks:
      - portfolio_network

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: portfolio_api
    # A seção ports expõe para a internet DIRETO pelo IP. 
    # Se quiser acessar só pela URL do Coolify, pode remover ou comentar isso.
    ports:
      - "${API_PORT:-9999}:9999"
    environment:
      # ... (suas envs continuam iguais) ...
      REDIS_URL: "${REDIS_URL}"
      PORT: "9999"
      PYTHONUNBUFFERED: "1"
      RESEND_API_KEY: "${RESEND_API_KEY}"
      MAIL_FROM: "${MAIL_FROM}"
      SMTP_TO: "${SMTP_TO}"
      EMAIL_RATE_LIMIT: "${EMAIL_RATE_LIMIT:-10}"
      EMAIL_RATE_WINDOW_SECONDS: "${EMAIL_RATE_WINDOW_SECONDS:-120}"
      BACKEND_CORS_ORIGINS: '${BACKEND_CORS_ORIGINS}'
    depends_on:
      redis:
        condition: service_healthy
    command: >
      uvicorn main:app --host 0.0.0.0 --port 9999
    restart: unless-stopped
    networks:
      - portfolio_network
    
    # --- AQUI ESTÁ A CORREÇÃO DO TRAEFIK ---
    labels:
      - "traefik.enable=true"
      # Aponta o proxy para a porta interna 9999
      - "traefik.http.services.api.loadbalancer.server.port=9999"
      # Garante que use a rota segura
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"

    # --- CORREÇÃO DO HEALTHCHECK ---
    healthcheck:
      # Mudei para /docs ou remova o -f se quiser manter na raiz
      test: ["CMD", "curl", "-f", "http://localhost:9999/health"] 
      interval: 30s
      timeout: 10s
      retries: 3

  celery:
    build:
      context: .
      dockerfile: Dockerfile.celery
    container_name: portfolio_celery
    environment:
      REDIS_URL: "${REDIS_URL}"
      PYTHONUNBUFFERED: "1"
      RESEND_API_KEY: "${RESEND_API_KEY}"
      MAIL_FROM: "${MAIL_FROM}"
      SMTP_TO: "${SMTP_TO}"
    depends_on:
      redis:
        condition: service_healthy
    command: >
      celery -A service.emailService.celery_app worker --pool solo -l info --queues celery
    restart: unless-stopped
    networks:
      - portfolio_network

volumes:
  redis_data:

networks:
  portfolio_network:
    driver: bridge
