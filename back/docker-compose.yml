version: "3.8"

services:
  redis:
    image: redis:7-alpine
    container_name: portfolio_redis
    command: >
      sh -c "redis-server --requirepass \"$REDIS_PASSWORD\""
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "$REDIS_PASSWORD", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    networks:
      - portfolio_network

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: portfolio_api
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      REDIS_URL: "redis://:${REDIS_PASSWORD}@redis:6379/0"
      PORT: "8000"
      PYTHONUNBUFFERED: "1"
      MAIL_SERVER: "${MAIL_SERVER}"
      MAIL_PORT: "${MAIL_PORT}"
      MAIL_USERNAME: "${MAIL_USERNAME}"
      MAIL_PASSWORD: "${MAIL_PASSWORD}"
      MAIL_FROM: "${MAIL_FROM}"
      SMTP_TO: "${SMTP_TO}"
      EMAIL_RATE_LIMIT: "${EMAIL_RATE_LIMIT:-10}"
      EMAIL_RATE_WINDOW_SECONDS: "${EMAIL_RATE_WINDOW_SECONDS:-120}"
      BACKEND_CORS_ORIGINS: "${BACKEND_CORS_ORIGINS}"
    depends_on:
      redis:
        condition: service_healthy
    command: >
      uvicorn main:app --host 0.0.0.0 --port 8000
    restart: unless-stopped
    networks:
      - portfolio_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3

  celery:
    build:
      context: .
      dockerfile: Dockerfile.celery
    container_name: portfolio_celery
    environment:
      REDIS_URL: "redis://:${REDIS_PASSWORD}@redis:6379/0"
      PYTHONUNBUFFERED: "1"
      MAIL_SERVER: "${MAIL_SERVER}"
      MAIL_PORT: "${MAIL_PORT}"
      MAIL_USERNAME: "${MAIL_USERNAME}"
      MAIL_PASSWORD: "${MAIL_PASSWORD}"
      MAIL_FROM: "${MAIL_FROM}"
      SMTP_TO: "${SMTP_TO}"
    depends_on:
      redis:
        condition: service_healthy
    command: >
      celery -A service.emailService.celery_app worker --pool solo -l info --queues celery
    restart: unless-stopped
    networks:
      - portfolio_network

volumes:
  redis_data:

networks:
  portfolio_network:
    driver: bridge
